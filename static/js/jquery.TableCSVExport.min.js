jQuery.fn.TableCSVExport=function(e){function t(t){return jQuery(t).find("tr"+e.rowFilter)}function r(t){return e.showHiddenRows?jQuery(t):jQuery(t).filter(":visible")}function n(t){var r=t.join("");if(t.length>0&&""!=r){var n=t.join(e.separator);a[a.length]=jQuery.trim(n)}}function i(e){var t=new RegExp(/["]/g),r=e.replace(t,'""');return r=r.replace("<br>"," "),(null==r||"object"!=typeof r)&&(r="<span>"+r+"</span>"),r=$(r).text().trim(),""==r?"":'"'+r+'"'}function o(t){if("download"==e.delivery){var r=new Blob([t],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(r,e.filename);else{var n=document.createElement("a");if(void 0!==n.download){var i=URL.createObjectURL(r);n.setAttribute("href",i),n.setAttribute("download",e.filename),n.style="visibility:hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}return!0}var o=window.open("","csv","height=400,width=600");return o.document.write("<html><head><title>CSV</title>"),o.document.write("</head><body >"),o.document.write('<textArea cols=70 rows=15 wrap="off" >'),o.document.write(t),o.document.write("</textArea>"),o.document.write("</body></html>"),o.document.close(),!0}var e=jQuery.extend({separator:",",header:[],columns:[],extraHeader:"",extraData:[],insertBefore:"",delivery:"popup",emptyValue:"",showHiddenRows:!1,rowFilter:"",filename:"download.csv"},e),a=[],l=this,d=0==e.columns.length?!0:!1,u=[],s=0,h=null,c=e.header.length,f=[];if(c>0){if(d)for(var m=0;c>m;m++)e.header[m]==e.insertBefore&&(f[f.length]=i(e.extraHeader),h=m),f[f.length]=i(e.header[m]);else if(!d)for(var y=0;c>y;y++)for(var m=0;m<e.columns.length;m++)e.columns[m]==e.header[y]&&(e.columns[m]==e.insertBefore&&(f[f.length]=i(e.extraHeader),h=y),f[f.length]=i(e.header[y]),u[s]=y,s++)}else r(l).find("th").each(function(){("none"!=jQuery(this).css("display")||e.showHiddenRows)&&(f[f.length]=i(jQuery(this).html()))});if(n(f),d){var v=0;t(l).each(function(){var t=[],o=0;r(this).find("td").each(function(){o==h&&(t[t.length]=jQuery.trim(e.extraData[v-1])),("none"!=jQuery(this).css("display")||e.showHiddenRows)&&(""==jQuery.trim(jQuery(this).html())?t[t.length]=i(e.emptyValue):t[t.length]=jQuery.trim(i(jQuery(this).html()))),o++}),n(t),v++})}else{var v=0;t(l).each(function(){var t=[],o=0,a=0;r(this).find("td").each(function(){o in u&&a==h&&(t[t.length]=jQuery.trim(i(e.extraData[v-1]))),("none"!=jQuery(this).css("display")||e.showHiddenRows)&&o in u&&(t[t.length]=jQuery.trim(i(jQuery(this).html()))),o++,a++}),n(t),v++})}if("popup"==e.delivery||"download"==e.delivery){var w=a.join("\n");return o(w)}var w=a.join("\n");return w};